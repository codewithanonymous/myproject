<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snapchat Clone - Admin</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Admin-specific styling */
        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .admin-dashboard {
            display: none;
        }

        .snap-list {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            margin-top: 2rem;
        }

        .snap-item {
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .snap-item:hover {
            transform: translateY(-5px);
        }

        .snap-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .snap-info {
            padding: 1rem;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-image {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .modal .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }

        .delete-button {
            background-color: #dc3545;
            color: white;
        }

        .delete-button:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <!-- Admin Login Form -->
    <div id="login-container" class="login-container">
        <h1 class="text-2xl text-center mb-4">Admin Login</h1>
        <div id="login-message-container"></div>
        <form id="admin-login-form">
            <div class="form-group">
                <label for="admin-username">Username</label>
                <input type="text" id="admin-username" name="username" required>
            </div>
            <div class="form-group">
                <label for="admin-password">Password</label>
                <input type="password" id="admin-password" name="password" required>
            </div>
            <button type="submit" class="button w-full">Login</button>
        </form>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-dashboard">
        <div class="container">
            <header class="flex justify-between items-center mb-4">
                <h1 class="text-2xl">Admin Dashboard</h1>
                <button id="logout-btn" class="button delete-button">Logout</button>
            </header>

            <div id="message-container"></div>

            <div id="snap-list" class="snap-list">
                <p class="text-center">Loading snaps...</p>
            </div>

        <!-- Snap Detail Modal -->
        <div id="snap-modal" class="modal">
            <div class="modal-content">
                <button class="close-button">&times;</button>
                <h2 class="text-2xl mb-4">Edit Snap</h2>
                <img id="modal-image" class="modal-image" src="" alt="Snap Preview">
                <form id="edit-snap-form">
                    <input type="hidden" id="edit-snap-id">
                    <div class="form-group">
                        <label for="edit-caption">Caption</label>
                        <input type="text" id="edit-caption" name="caption">
                    </div>
                    <div class="form-group">
                        <label for="edit-hashtags">Hashtags</label>
                        <input type="text" id="edit-hashtags" name="hashtags">
                    </div>
                    <div class="form-group">
                        <label>Posted by:</label>
                        <p id="edit-uploader"></p>
                    </div>
                    <div class="form-group">
                        <label>Posted at:</label>
                        <p id="edit-time"></p>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="button">Update Snap</button>
                        <button type="button" id="delete-snap-btn" class="button delete-button">Delete Snap</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/utils.js"></script>
    <script>
        const snapListContainer = document.getElementById('snap-list');
        const snapModal = document.getElementById('snap-modal');
        const closeModalBtn = snapModal.querySelector('.close-button');
        const editSnapForm = document.getElementById('edit-snap-form');
        const deleteSnapBtn = document.getElementById('delete-snap-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // Admin authentication
        const adminLoginForm = document.getElementById('admin-login-form');
        const loginContainer = document.getElementById('login-container');
        const adminDashboard = document.getElementById('admin-dashboard');

        // Server-side admin authentication
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Store admin token and info
                    localStorage.setItem('adminToken', result.token);
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminUsername', result.admin.username);
                    
                    // Show dashboard
                    loginContainer.style.display = 'none';
                    adminDashboard.style.display = 'block';
                    fetchSnaps();
                    showLoginMessage(result.message, 'success');
                } else {
                    showLoginMessage(result.message || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginMessage('Connection error. Please try again.', 'error');
            }
        });

        // Check if admin is already logged in
        if (localStorage.getItem('adminLoggedIn') === 'true') {
            loginContainer.style.display = 'none';
            adminDashboard.style.display = 'block';
            fetchSnaps();
        }

        // Function to fetch and display all snaps
        async function fetchSnaps() {
            try {
                const response = await fetch('/api/feed?limit=100');
                if (!response.ok) {
                    throw new Error('Failed to fetch snaps.');
                }
                const data = await response.json();
                renderSnaps(data.snaps || []);
            } catch (error) {
                console.error(error);
                showMessage('An error occurred while loading snaps.', 'error');
            }
        }

        // Function to render the list of snaps
        function renderSnaps(snaps) {
            snapListContainer.innerHTML = '';
            if (snaps.length === 0) {
                snapListContainer.innerHTML = `<p class="text-center">No snaps available.</p>`;
                return;
            }

            snaps.forEach(snap => {
                const snapItem = document.createElement('div');
                snapItem.className = 'snap-item';
                snapItem.setAttribute('data-id', snap.id);
                const hashtags = Array.isArray(snap.hashtags) ? snap.hashtags.join(', ') : (snap.hashtags || '');
                snapItem.innerHTML = `
                    <img src="${snap.imageUrl}" alt="Snap by ${snap.username}" class="snap-thumbnail">
                    <div class="snap-info">
                        <p><strong>User:</strong> ${snap.username}</p>
                        <p><strong>Caption:</strong> ${snap.caption || 'No caption'}</p>
                        <p><strong>Hashtags:</strong> ${hashtags || 'None'}</p>
                        <p><strong>Posted:</strong> ${new Date(snap.createdAt).toLocaleDateString()}</p>
                    </div>
                `;
                snapListContainer.appendChild(snapItem);
            });
        }

        // Function to open the modal with snap details
        async function openModal(snapId) {
            try {
                const response = await fetch(`/api/snaps/${snapId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch snap details');
                }
                const data = await response.json();
                const snap = data.snap;

                if (!snap) {
                    showMessage('Snap not found.', 'error');
                    return;
                }

                document.getElementById('edit-snap-id').value = snap.id;
                document.getElementById('modal-image').src = snap.imageUrl;
                document.getElementById('edit-caption').value = snap.caption || '';
                const hashtags = Array.isArray(snap.hashtags) ? snap.hashtags.join(', ') : (snap.hashtags || '');
                document.getElementById('edit-hashtags').value = hashtags;
                document.getElementById('edit-uploader').textContent = snap.username;
                document.getElementById('edit-time').textContent = new Date(snap.createdAt).toLocaleString();

                snapModal.style.display = 'flex';
            } catch (error) {
                console.error(error);
                showMessage('Failed to load snap details.', 'error');
            }
        }

        // Event listener for clicking on a snap item
        snapListContainer.addEventListener('click', (e) => {
            const snapItem = e.target.closest('.snap-item');
            if (snapItem) {
                const snapId = snapItem.getAttribute('data-id');
                openModal(snapId);
            }
        });

        // Event listener for closing the modal
        closeModalBtn.addEventListener('click', () => {
            snapModal.style.display = 'none';
        });

        // Event listener for updating a snap
        editSnapForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const snapId = document.getElementById('edit-snap-id').value;
            const caption = document.getElementById('edit-caption').value;
            const hashtags = document.getElementById('edit-hashtags').value;

            try {
                const response = await fetch(`/api/admin/snap/${snapId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ caption, hashtags })
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message, 'success');
                    snapModal.style.display = 'none';
                    fetchSnaps(); // Refresh the list
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error updating snap:', error);
                showMessage('An unexpected error occurred.', 'error');
            }
        });

        // Event listener for deleting a snap
        deleteSnapBtn.addEventListener('click', async () => {
            const snapId = document.getElementById('edit-snap-id').value;
            if (confirm('Are you sure you want to delete this snap? This action cannot be undone.')) {
                try {
                    const response = await fetch(`/api/snaps/${snapId}`, { method: 'DELETE' });
                    if (response.ok) {
                        showMessage('Snap deleted successfully', 'success');
                        snapModal.style.display = 'none';
                        fetchSnaps();
                    } else {
                        showMessage('Failed to delete snap', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting snap:', error);
                    showMessage('An unexpected error occurred.', 'error');
                }
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUsername');
            loginContainer.style.display = 'block';
            adminDashboard.style.display = 'none';
        });

        // Message display functions
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        function showLoginMessage(message, type) {
            const container = document.getElementById('login-message-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 3000);
        }

        // Initial load
        window.onload = fetchSnaps;
    </script>
</body>
</html>
